# 家計簿アプリ 仕様（SPEC）

## 1. 目的
- Webで動作する家計簿アプリ（将来スマホアプリ化も視野）
- 市販の家計簿に寄せた「縦:日付 / 横:カテゴリ」月間表を主軸
- 複数ユーザー利用前提（ユーザーごとに完全分離）
- 無駄なDBアクセスを抑え、Cloudflare（D1 + Workers/Pages）で運用しやすくする

## 2. 画面構成（タブ）
1. 月間（メイン）
2. 週間（ビュー切替）
3. 集計（カテゴリ円・日別折れ線）
4. 設定（予算、締め日、カテゴリ編集 など）
5. 出力（CSV/PDF、アーカイブ表示）

## 3. 月間（メイン）画面仕様
### 3.1 画面レイアウト
- 上部
  - 月選択
  - 月予算
  - 月残（= 月予算 − 月支出）
  - 締め日情報
  - 注意文言エリア（例：日予算合計 > 月予算など）
- 中央：月間表（縦:日付 / 横:カテゴリ）
  - 表示対象は「支出のみ」
  - カテゴリ増加時は横スクロール
  - 右端に「日合算（その日の総支出）」列を固定表示（横スクロールしても常に見える）
- 下部：カテゴリ毎の合算行を表示（横軸カテゴリの合算）
- 追加領域：選択範囲（日/セルなど）の明細一覧＋明細追加フォーム

### 3.2 表示ルール
- 各セルは「その日×カテゴリの支出合計」を表示（明細入力を集計して表示）
- 日合算は、その日の全カテゴリ支出合計
- カテゴリ合算は、月内のカテゴリ別支出合計
- 日予算超過は赤表示（その日の支出合計 vs その日の日予算）

## 4. 明細（入力）仕様
- 1明細 = 日付 / 金額 / カテゴリ / メモ / 支払方法(任意)
- 支払方法（固定セット）
  - 現金 / クレカ / 銀行引落 / QR / その他（未入力可）
- 収入
  - 入力可能（固定/臨時/複数）
  - ただし「月間表」は支出のみ表示（収入は集計・出力に含めて良い）

## 5. 期間（締め日・月の定義）
- デフォルト：暦月（1日〜末日）
- 締め日指定をサポート（例：25日締め = 26日〜翌25日）
- 期間は常に「1ヶ月固定」（1/1〜1/20 など中途半端な期間は不可）
- 週の開始曜日は月曜日

## 6. 予算・残高
### 6.1 月予算 / 日予算
- 月予算：手入力
- デフォルト日予算：月予算 ÷ 月の日数（切り捨て）
- 日予算は手入力で日別に上書き可能（上書きがある日だけ保存）
- 日予算合計 > 月予算 の場合は注意文言を表示

### 6.2 残高（表示）
- 残高は「予算残」を表示
- 月残（= 月予算 − 月支出）を上部に表示
- 日行には残高を表示しない
- 口座残高（貯金額など）はメモ的な手入力情報として扱い、計算には含めない

## 7. 集計
- カテゴリ別合計（支出）を月単位で表示
- グラフ
  - カテゴリ円グラフ
  - 日別折れ線グラフ
- 月の合算値（例：月支出合計、カテゴリ別合計など）を表示

## 8. 出力（CSV / PDF）
### 8.1 CSV
- 出力は「ひと月分の明細CSV」のみ（集計CSV不要）
- 出力対象は常に指定した1ヶ月分

### 8.2 PDF（A4・固定2枚）
- PDFは固定2枚構成（ファイリング前提）
  - 1枚目：ひと月分の明細（詳細一覧）
  - 2枚目：グラフ（円/折れ線）＋ひと月分の合算値
- 複数ページ許容だが、仕様としては2枚固定で進める

### 8.3 アーカイブ（端末保存・手動削除）
- CSV/PDFはユーザー端末へダウンロード保存（サーバ保管しない）
- 古い月の削除はユーザー操作のみ（自動削除しない）
- 2年以上前データが存在する場合は整理を促すメッセージを表示

### 8.4 アーカイブCSV読み込み表示
- 出力タブに「アーカイブCSVを読み込む」
- 読み込み後はアーカイブ表示モードで閲覧可能（読み取り専用）
- 保存不可（文言：**「アーカイブ表示のため保存できません」**）
- 復元ボタンは作らない

## 9. マルチユーザー・データ管理（B案）
### 9.1 ユーザー分離
- user_id により完全分離（他ユーザーのデータが混ざらない）

### 9.2 DBアクセス最小化（必須ルール）
- 月を開いたら「1ヶ月分データセット」を取得し、以降のタブ切替/スクロール/セル選択で追加取得しない
- 検索・フィルタは月内データをローカル処理（サーバ検索はMVPでしない）
- CSV/PDF出力は画面にロード済みの1ヶ月データから生成（出力のための再取得なし）

### 9.3 キャッシュ（必須ルール）
- 月キャッシュ：直近6ヶ月（LRU）
- TTL：当月120分 / 過去月24時間
- 起動（ログイン）時は当月のみ必ず1回取得して最新化

### 9.4 保存（差分更新）と競合チェック（必須ルール）
- 保存は差分更新（追加/編集/削除）で行い、更新後に一覧の再取得はしない
- 変更がない場合、保存操作はクエリ発行なし（ノーオペ）
- 競合チェック：
  - 保存時は当月 months.version の一致を必須
  - 不一致なら保存を拒否し「最新取得→再編集」を促す

## 10. DB設計（概要）
- users：ユーザー識別
- months：月ヘッダ（version、月予算、締め日情報など）
- entries：明細（expense/income）
- categories：ユーザー別カテゴリ（階層なし）
- daily_budgets：日予算上書き（存在する日だけ）
