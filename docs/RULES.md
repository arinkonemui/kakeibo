# 開発ルール（RULES）

## 1. 基本方針
- 本プロジェクトは「仕様（docs/SPEC.md）」をソースオブトゥルースとする
- DBアクセス最小化・キャッシュ・競合チェックは「必須仕様」であり、勝手に緩めない
- UI文言はユーザー向けにし、内部用語（DBなど）を露出させない

## 2. 非機能（性能・運用）ルール
### 2.1 DBアクセス最小化（必須）
- 1ヶ月表示は「months + entries + daily_budgets」を月単位でまとめて取得する
- タブ切替/スクロール/セル選択/グラフ表示で追加の取得をしない
- 出力（CSV/PDF）はロード済みデータから生成し、出力のための再取得を禁止

### 2.2 キャッシュ（必須）
- 月キャッシュ：直近6ヶ月（LRU）
- TTL：当月120分 / 過去月24時間
- 起動時：当月のみ必ず1回取得して最新化（以降はキャッシュ優先）
- 変更が発生した場合：サーバ再取得ではなくローカルデータセットへ差分反映

### 2.3 競合チェック（必須）
- 保存時は months.version の一致を必須とする
- 不一致なら保存を拒否し「最新取得→再編集」を促す
- 「月データ丸ごと上書き」方式は禁止（差分更新のみ）

## 3. UI/文言ルール
- アーカイブCSV表示中の文言は必ず以下：
  - **「アーカイブ表示のため保存できません」**
- 「DB」などの内部概念をユーザーに見せない

## 4. アーカイブ運用ルール
- アーカイブは端末ダウンロード（サーバ保管しない）
- 削除はユーザー操作のみ（自動削除しない）
- 2年以上前データがある場合、整理を促す案内を表示（削除はしない）
- アーカイブCSV読み込みは閲覧専用（保存不可、復元ボタンなし）

## 5. 変更管理（必須）
- 仕様変更が発生する場合は docs/SPEC.md を先に更新し、差分の意図を docs/AGENT_LOG.md に残す

## 6. 開発ログ（必須）
- 開発時は **docs/AGENT_LOG.md を追記式（append-only）で作成・運用**する
- 追記内容の最低要件：
  - 日時
  - 目的（何をしたか）
  - 変更ファイル一覧
  - 主要な設計判断（なぜそうしたか）
  - 動作確認（実行した手順・結果）
  - 残課題/次アクション
- 既存ログの改変・削除は禁止（誤りは追記で訂正）
